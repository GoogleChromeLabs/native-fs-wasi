const t=new WeakMap;class e{constructor(){this.state={type:"Loading"},this.exports=null}invalidState(){throw new Error(`Invalid async state ${this.state.type}`)}wrapImportFn(t){return(...e)=>{switch(this.state.type){case"None":{let s=t(...e);return!(n=s)||"object"!=typeof n&&"function"!=typeof n||"function"!=typeof n.then?s:(this.exports.asyncify_start_unwind(16),this.state={type:"Unwinding",promise:s},0)}case"Rewinding":{let{value:t}=this.state;return this.state={type:"None"},this.exports.asyncify_stop_rewind(),t}default:this.invalidState()}var n}}wrapModuleImports(t){let e={};for(let n in t){let s=t[n];"function"==typeof s&&(s=this.wrapImportFn(s)),e[n]=s}return e}wrapImports(t){if(void 0===t)return;let e={};for(let n in t)e[n]=this.wrapModuleImports(t[n]);return e}wrapExportFn(e){let n=t.get(e);return void 0!==n?n:(n=async(...t)=>{"None"!==this.state.type&&this.invalidState();let n=e(...t);for(;"Unwinding"===this.state.type;){let t,{promise:s}=this.state;this.state={type:"None"},this.exports.asyncify_stop_unwind(),this.state={type:"Waiting"};try{t=await s}finally{this.state={type:"None"}}this.exports.asyncify_start_rewind(16),this.state={type:"Rewinding",value:t},n=e()}return"None"!==this.state.type&&this.invalidState(),n},t.set(e,n),n)}wrapExports(e){let n=t.get(e);if(void 0!==n)return n;n=Object.create(null);for(let t in e){let s=e[t];"function"!=typeof s||t.startsWith("asyncify_")||(s=this.wrapExportFn(s)),Object.defineProperty(n,t,{enumerable:!0,value:s})}return t.set(e,n),n}init(t,e){const{exports:s}=t,r=s.memory||e.env&&e.env.memory,i=new Int32Array(r.buffer,16);i[0]=24,i[1]=512,this.state={type:"None"},this.exports=this.wrapExports(s),Object.setPrototypeOf(t,n.prototype)}}class n extends WebAssembly.Instance{constructor(t,n){let s=new e;super(t,s.wrapImports(n)),s.init(this,n)}get exports(){return t.get(super.exports)}}async function s(t,n){let s=new e,r=await WebAssembly.instantiate(t,s.wrapImports(n));return s.init(r instanceof WebAssembly.Instance?r:r.instance,n),r}async function r(t,n){let s=new e,r=await WebAssembly.instantiateStreaming(t,s.wrapImports(n));return s.init(r.instance,n),r}Object.defineProperty(n.prototype,"exports",{enumerable:!0});export{n as Instance,s as instantiate,r as instantiateStreaming};
